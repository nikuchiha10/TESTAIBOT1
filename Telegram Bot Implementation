import logging
from telegram.ext import Application, CommandHandler, MessageHandler, filters, CallbackQueryHandler
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import ContextTypes
import os
import sys

# Add parent directory to path
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from config import config
from handlers import (
    start_command, help_command, upload_base_command, 
    reset_command, status_command, handle_message,
    handle_file_upload, handle_button_click
)
from loguru import logger

class RussianAIAssistant:
    def __init__(self):
        self.application = Application.builder().token(config.BOT_TOKEN).build()
        self.setup_handlers()
        
    def setup_handlers(self):
        """Setup all command and message handlers"""
        # Command handlers
        self.application.add_handler(CommandHandler("start", start_command))
        self.application.add_handler(CommandHandler("help", help_command))
        self.application.add_handler(CommandHandler("upload_base", upload_base_command))
        self.application.add_handler(CommandHandler("reset", reset_command))
        self.application.add_handler(CommandHandler("status", status_command))
        
        # File upload handler
        self.application.add_handler(MessageHandler(
            filters.Document.ALL, handle_file_upload
        ))
        
        # Text message handler
        self.application.add_handler(MessageHandler(
            filters.TEXT & ~filters.COMMAND, handle_message
        ))
        
        # Button click handler
        self.application.add_handler(CallbackQueryHandler(handle_button_click))
        
    def run(self):
        """Start the bot"""
        logger.info("Starting Russian AI Assistant Bot...")
        self.application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == "__main__":
    # Create necessary directories
    os.makedirs(config.KNOWLEDGE_BASE_DIR, exist_ok=True)
    os.makedirs(config.DATA_DIR, exist_ok=True)
    
    bot = RussianAIAssistant()
    bot.run()
